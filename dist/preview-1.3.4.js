/*!
  GeoPortal Genie by Stephen Lead
  GeoPortalGenie.com
*/
;var previewMap,identifyLayers,wmsLayer,wmsLayerName,identifyPoint,wmsVersion,cleanURL;require(["esri/map","esri/geometry/Extent","esri/layers/FeatureLayer","esri/layers/WMSLayer","esri/layers/WMSLayerInfo","esri/arcgis/utils","esri/IdentityManager","esri/tasks/GeometryService","esri/tasks/ProjectParameters","esri/dijit/PopupMobile","dojo/dom-construct","esri/virtualearth/VETiledLayer","dojo/domReady!"],function(g,z,t,k,d,j,p,r,f,l,e,o){if(configOptions.bingMapsOptions){previewMap=new g("previewMap");if(configOptions.bingMapsOptions.bingMapsStyle){var x=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS;switch(configOptions.bingMapsOptions.bingMapsStyle){case"ROAD":x=esri.virtualearth.VETiledLayer.MAP_STYLE_ROAD;break;case"AERIAL":x=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL;break;case"AERIAL_WITH_LABELS":x=esri.virtualearth.VETiledLayer.MAP_STYLE_AERIAL_WITH_LABELS;break}}var n=new esri.virtualearth.VETiledLayer({bingMapsKey:configOptions.bingMapsOptions.bingMapsKey,mapStyle:x});previewMap.addLayer(n)}else{previewMap=new g("previewMap",configOptions.mapOptions)}var b=new esri.dijit.Popup({fillSymbol:new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([255,0,0]),2),new dojo.Color([255,255,0,0.25])),lineSymbol:new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_DASH,new dojo.Color([255,0,0]),3),markerSymbol:new esri.symbol.SimpleMarkerSymbol("circle",32,null,new dojo.Color([0,0,0,0.25]))},dojo.create("div"));previewMap.infoWindow=b;previewMap.on("update-start",function(){$("#status").show()});previewMap.on("update-end",function(){$("#status").hide()});var h=i("url");$("#goToSite").attr("href",h);var q=i("previewType")||"unknown";var a=i("bbox");esri.config.defaults.io.proxyUrl=configOptions.mapProxy||"map_proxy.php";if(q==="ags"){esri.request({url:h,content:{f:"json"},handleAs:"json",callbackParamName:"callback",load:function(B){var C;if(B.singleFusedMapCache){C=new esri.layers.ArcGISTiledMapServiceLayer(h)}else{if(B.fields&&B.fields.length>0){var D=new esri.InfoTemplate("","${*}");C=new esri.layers.FeatureLayer(h,{mode:esri.layers.FeatureLayer.MODE_ONDEMAND,infoTemplate:D,outFields:["*"]})}else{if(B.layers){C=new esri.layers.ArcGISDynamicMapServiceLayer(h);identifyLayers=B.layers;previewMap.on("click",function(E){$("#status").show();v(E)})}else{m(h)}}}if(C!==undefined){C.setVisibility(true);C.setOpacity(0.75);previewMap.addLayer(C);if(a!==undefined&&a!==null){s(a)}}else{m(h)}$("#arcgisonline").attr("href","http://www.arcgis.com/home/webmap/viewer.html?url="+h);$(".agol").show()},error:function(B){alert("Sorry, there was a problem adding this data to the preview map: "+B.message)}})}else{if(q==="wms"){var y={REQUEST:"GetCapabilities",SERVICE:"WMS"};var w=configOptions.mapProxy||"map_proxy.php";cleanURL=h.replace("request=GetCapabilities","");if(cleanURL.substr(cleanURL.length-1)!=="?"){cleanURL+="?"}var A=w+"?"+cleanURL;$.ajax({type:"GET",url:A,data:y,dataType:"xml",success:function(E){var D=$.xml2json(E);var B="Sorry, there was a problem retrieving this service";if(D.ServiceException!==undefined){B=B+": "+D.ServiceException;alert(B)}else{if(D.Exception!==undefined){if(D.Exception.ExceptionText!==undefined){B=B+": "+D.Exception.ExceptionText}alert(B)}else{if(D.Capability.Layer.Layer.queryable=="1"){wmsLayerName=D.Capability.Layer.Layer.Name;wmsVersion=D.version||"1.1.1";var I={layerInfos:[new esri.layers.WMSLayerInfo({name:wmsLayerName,title:wmsLayerName})]};var C;var G="SRS";if(wmsVersion==="1.3.0"){G="CRS"}for(var F=0;F<D.Capability.Layer.BoundingBox.length;F++){var H=D.Capability.Layer.BoundingBox[F];if(H[G]==="EPSG:102113"){C=new esri.SpatialReference(102113);break}else{if(H[G]==="EPSG:102100"){C=new esri.SpatialReference(102100);break}else{if(H[G]==="EPSG:4326"){C=new esri.SpatialReference(4326);break}}}}if(C!==undefined){I.extent=new esri.geometry.Extent(H.xmin,H.ymin,H.xmax,H.ymax,C)}wmsLayer=new esri.layers.WMSLayer(h.replace("request=GetCapabilities",""),{resourceInfo:I});wmsLayer.setVisibleLayers([0]);wmsLayer.setImageFormat("png");wmsLayer.setOpacity(0.75);previewMap.addLayer(wmsLayer);previewMap.on("click",function(J){$("#status").show();previewMap.setMapCursor("wait");previewMap.infoWindow.hide();identifyPoint=J;var M=previewMap.extent;var L=new Array();L.push(new esri.geometry.Point(M.xmin,M.ymin,M.spatialReference));L.push(new esri.geometry.Point(M.xmax,M.ymax,M.spatialReference));var K=new esri.tasks.GeometryService("http://sampleserver3.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");K.evt=J;K.project(L,wmsLayer.spatialReference,function(Q){var O=new esri.geometry.Extent(Q[0].x,Q[0].y,Q[1].x,Q[1].y,Q[0].spatialReference);var P={REQUEST:"GetFeatureInfo",SERVICE:"WMS",VERSION:"1.1.1",SRS:"EPSG:"+O.spatialReference.wkid.toString(),LAYERS:wmsLayerName,FORMAT:"image/png",BBOX:O.xmin.toString()+","+O.ymin.toString()+","+O.xmax.toString()+","+O.ymax.toString(),WIDTH:previewMap.width.toString(),HEIGHT:previewMap.height.toString(),QUERY_LAYERS:wmsLayerName,X:identifyPoint.screenPoint.x.toString(),Y:identifyPoint.screenPoint.y.toString()};var N=configOptions.mapProxy||"map_proxy.php";$.ajax({type:"GET",url:N+"?"+cleanURL,data:P,dataType:"xml",success:function(R){var T=$.xml2json(R);if(T.FIELDS!==undefined){previewMap.infoWindow.clearFeatures();var S="<table id='wmsIdentify'>";for(key in T.FIELDS){S+="<tr><td>"+key+"</td><td>"+T.FIELDS[key]+"</td></tr>"}S+="</table>";previewMap.infoWindow.setContent(S);if(configOptions.infoWindow){previewMap.infoWindow.resize(configOptions.infoWindow.width,configOptions.infoWindow.height)}previewMap.infoWindow.show(identifyPoint.mapPoint)}$("#status").hide();previewMap.setMapCursor("default")},error:function(R,T,S){console.log("There was problem with the Identify functionality");previewMap.setMapCursor("default");$("#status").hide()}})},function(N){console.log("There was a problem calculating the extent of the WMS layer");previewMap.setMapCursor("default");$("#status").hide()})})}}}},error:function(B){alert("error with WMS layer: "+B.message)}});if(a!==undefined&&a!==null){s(a)}}else{m(h)}}function i(C){var B=(new RegExp("[\\?&]"+C+"=([^&#]*)")).exec(window.location.href);if(B==null){return null}else{return B[1]}}function m(B){$("#previewIFrame").attr("src",B);$("#previewIFrame").css("background","none");$("#previewMap").hide();$("#previewIFrame").show()}function s(D){D=D.split(",");var B=new esri.geometry.Extent(parseFloat(D[0]),parseFloat(D[1]),parseFloat(D[2]),parseFloat(D[3]),{wkid:4326});var C=esri.geometry.geographicToWebMercator(B);previewMap.setExtent(C,true)}function v(B){if(B.graphic){return null}identifyPoint=B.mapPoint;previewMap.infoWindow.hide();previewMap.setMapCursor("wait");dojo.connect(previewMap.infoWindow,"onSelectionChange",function(){var I=previewMap.infoWindow.selectedIndex+1;previewMap.infoWindow.setTitle("("+I+" of "+previewMap.infoWindow.count+")")});var H=dojo.map(identifyLayers,function(I){return new esri.tasks.IdentifyTask(h)});var G=dojo.map(H,function(I){return new dojo.Deferred()});var D=new dojo.DeferredList(G);D.then(c);for(var C=0;C<H.length;C++){try{var F=new esri.tasks.IdentifyParameters();F.tolerance=configOptions.identifyTolerance||10;F.returnGeometry=true;F.layerOption=esri.tasks.IdentifyParameters.LAYER_OPTION_VISIBLE;F.width=previewMap.width;F.height=previewMap.height;F.geometry=B.mapPoint;F.mapExtent=previewMap.extent;F.layerIds=[C];H[C].execute(F,G[C].callback,G[C].errback)}catch(E){console.log("Error caught");console.log(E);G[C].errback(E)}}}function c(H){var F=[];H=dojo.filter(H,function(J){return H[0]});for(var E=0;E<H.length;E++){F=F.concat(H[E][1])}var G=[];for(var C=0;C<F.length;C++){var D=F[C].feature;var B=D.attributes;var I=new esri.InfoTemplate;I.setTitle="";D.setInfoTemplate(I);G.push(D)}if(G.length>0){previewMap.infoWindow.setFeatures(G);if(G.length>1){previewMap.infoWindow.setTitle("("+(previewMap.infoWindow.selectedIndex+1)+" of "+previewMap.infoWindow.count+")")}else{previewMap.infoWindow.setTitle()}previewMap.infoWindow.show(identifyPoint)}else{previewMap.infoWindow.clearFeatures()}previewMap.setMapCursor("default");$("#status").hide();return G}function u(C){var E={};var B=C.length;for(var D=0;D<B;D++){E[C[D]]=""}return E}});